# @file
# GitHub Workflow for build checks
#
# Copyright (c) 2023, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# SPDX-License-Identifier: BSD-2-Clause-Patent
##
name: "Uncrustify check"
on:
  pull_request:
    branches:
      - uncrustify-check
    paths:
      - '**/*.h'
      - '**/*.c'

jobs:
  uncrustify-check:
    runs-on: ubuntu-latest
    name: Uncrustify check
    steps:
      - name: checkout edk2
        uses: actions/checkout@v3
        with:
          repository: tianocore/edk2
          path: ./edk2
      - name: checkout edk2-redfish-client
        uses: actions/checkout@v3
        with:
          path: ./edk2-redfish-client
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: ${{ github.event.pull_request.commits }}
      - name: Process files changed in the current commit
        run: |
          echo "commits: ${{ github.event.pull_request.commits }}"
          cd ./edk2-redfish-client
          changedFiles=$(git diff --name-only HEAD~${{ github.event.pull_request.commits }})
          for file in $changedFiles; do
            echo "Processing file: $file"
          done
      - name: uncrustify check
        run: |
          curl -L https://github.com/uncrustify/uncrustify/archive/refs/tags/uncrustify-0.73.0.tar.gz -o uncrustify.tar.gz
          tar zxf uncrustify.tar.gz
          cd uncrustify-uncrustify-0.73.0
          mkdir build
          cd build
          cmake ..
          cmake --build .
          cp uncrustify /usr/local/bin && chmod +x /usr/local/bin/uncrustify
          cd ../..
          uncrustify -c ./edk2/.pytool/Plugin/UncrustifyCheck/uncrustify.cfg -f ./edk2/RedfishPkg/RedfishRstExDxe/ComponentName.c --check
          cat result.txt

        shell: bash
